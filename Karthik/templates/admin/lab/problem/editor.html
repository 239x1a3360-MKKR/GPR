{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}Problem Editor - {{ problem.title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
<style>
    .CodeMirror {
        height: 400px;
        font-size: 14px;
        border: 1px solid #ddd;
    }

    .test-passed {
        background: #d4edda;
        border-left: 4px solid #28a745;
        padding: 10px;
        margin-bottom: 5px;
    }

    .test-failed {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        padding: 10px;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:lab_problem_changelist' %}">Problems</a>
    &rsaquo; {{ problem.title }}
    &rsaquo; Editor
</div>
{% endblock %}

{% block content %}
<h1>Problem Editor: {{ problem.title }}</h1>

<div style="margin: 20px 0;">
    <a href="{% url 'admin:lab_problem_change' problem.id %}" class="button">‚Üê Back to Problem</a>
    <a href="{% url 'admin:lab_problem_changelist' %}" class="button">‚Üê Back to Problems List</a>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
    <!-- Left Column: Problem Statement -->
    <div style="background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h2 style="border-bottom: 2px solid #417690; padding-bottom: 10px; margin-bottom: 20px;">
            Problem Statement
        </h2>

        <form method="post" action="{% url 'admin:lab_problem_change' problem.id %}">
            {% csrf_token %}
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Title:</label>
                <input type="text" name="title" value="{{ problem.title }}"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;" required>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Description:</label>
                <textarea name="description" rows="10"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-family: inherit;"
                    required>{{ problem.description }}</textarea>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Topic:</label>
                <select name="topic" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="">---------</option>
                    {% for topic in topics %}
                    <option value="{{ topic.id }}" {% if problem.topic_id==topic.id %}selected{% endif %}>{{ topic.name
                        }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Difficulty:</label>
                <select name="difficulty"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="easy" {% if problem.difficulty=='easy' %}selected{% endif %}>Easy</option>
                    <option value="medium" {% if problem.difficulty=='medium' %}selected{% endif %}>Medium</option>
                    <option value="hard" {% if problem.difficulty=='hard' %}selected{% endif %}>Hard</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Points:</label>
                <input type="number" name="points" value="{{ problem.points }}"
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;" required>
            </div>

            <div style="margin-bottom: 15px;">
                <label>
                    <input type="checkbox" name="is_active" {% if problem.is_active %}checked{% endif %}>
                    Is Active (visible to students)
                </label>
            </div>

            <button type="submit" class="default"
                style="padding: 10px 20px; background: #417690; color: white; border: none; border-radius: 3px; cursor: pointer;">
                Save Problem Statement
            </button>
        </form>
    </div>

    <!-- Right Column: Test Cases Summary -->
    <div style="background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h2 style="border-bottom: 2px solid #417690; padding-bottom: 10px; margin-bottom: 20px;">
            Test Cases Summary
        </h2>

        <div
            style="margin-bottom: 20px; padding: 15px; background: #e8f4f8; border-left: 4px solid #417690; border-radius: 3px;">
            <strong>Total Test Cases:</strong> {{ problem.test_cases.count }}<br>
            <strong>Sample (Visible):</strong> {{ sample_test_cases.count }}<br>
            <strong>Hidden (Evaluation):</strong> {{ hidden_test_cases.count }}
        </div>

        <p style="color: #666; font-size: 14px;">
            <strong>Note:</strong> Use the sections below to manage test cases.
            Sample test cases are shown to students. Hidden test cases are used only for evaluation.
        </p>

        <!-- Admin Test Area -->
        <h3 style="margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Test Solution</h3>
        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Use this editor to verify your test cases against
            a correct solution.</p>

        <select id="admin-language" style="margin-bottom: 10px; padding: 5px;">
            <option value="python">Python</option>
            <option value="c">C</option>
            <option value="cpp">C++</option>
            <option value="java">Java</option>
        </select>

        <textarea id="admin-editor"></textarea>

        <div style="margin-top: 10px;">
            <button type="button" class="button" onclick="runAdminCode('run')" style="background: #17a2b8;">Run (Sample
                Only)</button>
            <button type="button" class="button" onclick="runAdminCode('submit')" style="background: #28a745;">Run All
                Tests</button>
        </div>

        <div id="admin-results" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></div>
    </div>
</div>

<!-- Sample Test Cases Section -->
<div
    style="background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 20px;">
    <h2 style="border-bottom: 2px solid #28a745; padding-bottom: 10px; margin-bottom: 20px; color: #28a745;">
        üìã Sample Test Cases (Visible to Students)
    </h2>

    <p style="color: #666; margin-bottom: 20px;">
        These test cases are shown to students to help them understand the problem requirements.
    </p>

    <a href="{% url 'admin:lab_problem_change' problem.id %}#sampletestcase_set-group" class="button"
        style="margin-bottom: 20px;">
        Manage Sample Test Cases ‚Üí
    </a>

    {% if sample_test_cases %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa;">
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">#</th>
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Input Data</th>
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Expected Output</th>
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Order</th>
            </tr>
        </thead>
        <tbody>
            {% for test_case in sample_test_cases %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 10px;">{{ forloop.counter }}</td>
                <td style="border: 1px solid #ddd; padding: 10px; font-family: monospace; background: #f8f9fa;">{{
                    test_case.input_data|truncatewords:10 }}</td>
                <td style="border: 1px solid #ddd; padding: 10px; font-family: monospace; background: #f8f9fa;">{{
                    test_case.expected_output|truncatewords:10 }}</td>
                <td style="border: 1px solid #ddd; padding: 10px;">{{ test_case.order }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #999; font-style: italic;">No sample test cases yet. Add them in the problem edit page.</p>
    {% endif %}
</div>

<!-- Hidden Test Cases Section -->
<div
    style="background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 20px;">
    <h2 style="border-bottom: 2px solid #dc3545; padding-bottom: 10px; margin-bottom: 20px; color: #dc3545;">
        üîí Hidden Test Cases (Evaluation Only)
    </h2>

    <p style="color: #666; margin-bottom: 20px;">
        These test cases are used only for evaluation. Students cannot see them.
    </p>

    <a href="{% url 'admin:lab_problem_change' problem.id %}#hiddentestcase_set-group" class="button"
        style="margin-bottom: 20px;">
        Manage Hidden Test Cases ‚Üí
    </a>

    {% if hidden_test_cases %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa;">
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">#</th>
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Input Data</th>
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Expected Output</th>
                <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Order</th>
            </tr>
        </thead>
        <tbody>
            {% for test_case in hidden_test_cases %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 10px;">{{ forloop.counter }}</td>
                <td style="border: 1px solid #ddd; padding: 10px; font-family: monospace; background: #f8f9fa;">{{
                    test_case.input_data|truncatewords:10 }}</td>
                <td style="border: 1px solid #ddd; padding: 10px; font-family: monospace; background: #f8f9fa;">{{
                    test_case.expected_output|truncatewords:10 }}</td>
                <td style="border: 1px solid #ddd; padding: 10px;">{{ test_case.order }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #999; font-style: italic;">No hidden test cases yet. Add them in the problem edit page.</p>
    {% endif %}
</div>

<style>
    .button {
        display: inline-block;
        padding: 8px 15px;
        background: #417690;
        color: white;
        text-decoration: none;
        border-radius: 3px;
        margin-right: 10px;
        font-size: 13px;
        cursor: pointer;
        border: none;
    }

    .button:hover {
        background: #205067;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script>
    let adminEditor;
    const problemId = {{ problem.id }};

    document.addEventListener('DOMContentLoaded', function () {
        adminEditor = CodeMirror.fromTextArea(document.getElementById('admin-editor'), {
            lineNumbers: true,
            theme: 'monokai',
            mode: 'python',
            indentUnit: 4,
            indentWithTabs: false,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
        });

        document.getElementById('admin-language').addEventListener('change', function (e) {
            let mode = 'python';
            const lang = e.target.value;
            if (lang === 'c' || lang === 'cpp') {
                mode = 'text/x-c++src';
            } else if (lang === 'java') {
                mode = 'text/x-java';
            }
            adminEditor.setOption('mode', mode);
        });
    });

    async function runAdminCode(mode) {
        const code = adminEditor.getValue();
        const language = document.getElementById('admin-language').value;
        const resultsDiv = document.getElementById('admin-results');

        if (!code.trim()) {
            alert('Please enter some code.');
            return;
        }

        resultsDiv.innerHTML = '<div style="color: #666;">Running...</div>';

        try {
            const response = await fetch('/api/execute/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    language: language,
                    code: code,
                    problem_id: problemId,
                    mode: mode
                })
            });

            const result = await response.json();

            let html = '';

            if (result.test_results) {
                html += `<div style="margin-bottom: 5px;"><strong>${result.test_cases_passed}/${result.total_test_cases} passed</strong></div>`;

                result.test_results.forEach((test, idx) => {
                    const cls = test.passed ? 'test-passed' : 'test-failed';
                    const status = test.passed ? 'Passed' : 'Failed';
                    html += `
                        <div class="${cls}">
                            <div style="font-weight: bold;">Test ${idx + 1} (${test.is_sample ? 'Sample' : 'Hidden'}): ${status}</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                Input: <code>${test.input}</code><br>
                                Expected: <code>${test.expected}</code><br>
                                Actual: <code>${test.actual}</code>
                            </div>
                        </div>
                     `;
                });
            } else if (result.output) {
                html = `<pre>${result.output}</pre>`;
            } else if (result.error) {
                html = `<div style="color: red;">${result.error}</div>`;
            }

            resultsDiv.innerHTML = html;

        } catch (e) {
            resultsDiv.innerHTML = `<div style="color: red;">Error: ${e}</div>`;
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}